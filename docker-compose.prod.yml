services:
  web:
    build:
      context: .
      dockerfile: Dockerfile.prod
      args:
        # Pass environment variables as build arguments
        # These are read from .env file or host environment
        # Docker Compose automatically loads .env file for variable substitution
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL:-${API_BASE_URL:-}}
        NEXT_PUBLIC_FIREBASE_API_KEY: ${NEXT_PUBLIC_FIREBASE_API_KEY:-}
        NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN: ${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN:-}
        NEXT_PUBLIC_FIREBASE_PROJECT_ID: ${NEXT_PUBLIC_FIREBASE_PROJECT_ID:-}
        NEXT_PUBLIC_STORAGE_BUCKET: ${NEXT_PUBLIC_STORAGE_BUCKET:-}
        NEXT_PUBLIC_MESSAGING_SENDER_ID: ${NEXT_PUBLIC_MESSAGING_SENDER_ID:-}
        NEXT_PUBLIC_APP_ID: ${NEXT_PUBLIC_APP_ID:-}
    container_name: reformly-web
    environment:
      - NODE_ENV=production
      - HOSTNAME=0.0.0.0
      - PORT=3000
      # Also set at runtime (for server-side code)
      - NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL:-${API_BASE_URL}}
      - NEXT_PUBLIC_FIREBASE_API_KEY=${NEXT_PUBLIC_FIREBASE_API_KEY}
      - NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN}
      - NEXT_PUBLIC_FIREBASE_PROJECT_ID=${NEXT_PUBLIC_FIREBASE_PROJECT_ID}
      - NEXT_PUBLIC_STORAGE_BUCKET=${NEXT_PUBLIC_STORAGE_BUCKET}
      - NEXT_PUBLIC_MESSAGING_SENDER_ID=${NEXT_PUBLIC_MESSAGING_SENDER_ID}
      - NEXT_PUBLIC_APP_ID=${NEXT_PUBLIC_APP_ID}
    env_file:
      - .env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s
    labels:
      # Traefik labels for automatic service discovery
      - "traefik.enable=true"
      - "traefik.http.routers.reformly-web.rule=Host(`web.129.212.162.195.sslip.io`)"
      - "traefik.http.routers.reformly-web.entrypoints=websecure"
      - "traefik.http.routers.reformly-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.reformly-web.loadbalancer.server.port=3000"
      # Alternative HTTP entrypoint (uncomment if needed)
      # - "traefik.http.routers.reformly-web-http.rule=Host(`web.129.212.162.195.sslip.io`)"
      # - "traefik.http.routers.reformly-web-http.entrypoints=web"
      # - "traefik.http.routers.reformly-web-http.middlewares=redirect-to-https"
    networks:
      - default
      - traefik_network
    # No ports exposed - using reverse proxy with domain on server
    # No volumes - using built image
    # For local testing, use docker-compose.prod.local.yml

networks:
  default:
    name: reformly_web_default
  traefik_network:
    external: true
    name: docker_default

